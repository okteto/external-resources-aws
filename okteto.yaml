name: oktacoshop

build:
  menu:
    context: menu

  kitchen:
    context: kitchen

  kitchen-dev:
    context: kitchen
    target: dev

deploy:
  image: okteto/pipeline-runner:1.0.0-sam
  commands:
  - name: create an AWS SQS queue
    command: |
      set -e
      output=$(aws sqs create-queue --queue-name ${OKTETO_NAMESPACE}-oktacoshop --tags owner=${OKTETO_NAME})
      queue=$(echo $output | jq '.["QueueUrl"]')
      echo "OKTETO_EXTERNAL_SQS_ENDPOINTS_QUEUE_URL=${queue}" >> $OKTETO_ENV
      echo "SQS_QUEUE_NAME=${OKTETO_NAMESPACE}-oktacoshop" >> $OKTETO_ENV

  - name: create an AWS S3 bucket
    command: |
      set -e
      bucket=${OKTETO_NAMESPACE}-oktacoshop
      aws s3api create-bucket --bucket $bucket --acl private --region us-east-1
      echo "OKTETO_EXTERNAL_S3_ENDPOINTS_BUCKET_URL=s3://${bucket}" >> $OKTETO_ENV

  - name: deploy the Menu microservice
    command: helm upgrade --install menu menu/chart --set image=${OKTETO_BUILD_MENU_IMAGE} --set queue=${OKTETO_EXTERNAL_SQS_ENDPOINTS_QUEUE_URL} --set aws.region=${AWS_REGION} --set aws.accessKey=${AWS_ACCESS_KEY_ID} --set aws.secretAccessKey=${AWS_SECRET_ACCESS_KEY} --set author=${OKTETO_NAMESPACE}-${OKTETO_NAME}

  - name: deploy the Kitchen microservice
    command: helm upgrade --install kitchen kitchen/chart --set image=${OKTETO_BUILD_KITCHEN_IMAGE} --set queue=$SQS_QUEUE_NAME --set aws.region=${AWS_REGION} --set aws.accessKey=${AWS_ACCESS_KEY_ID} --set aws.secretAccessKey=${AWS_SECRET_ACCESS_KEY}

destroy:
  image: okteto/pipeline-runner:1.0.0-sam
  commands:
  - name: delete AWS S3 bucket
    command: |
      sh s3/destroy.sh

  - name: delete AWS SQS queue
    command: |
      sh sqs/destroy.sh

external:
  sqs:
    icon: storage
    endpoints:
    - name: queue
  s3:
    icon: storage
    endpoints:
    - name: bucket

dev:
  menu:
    command: bash
    sync:
    - menu:/usr/src/app
    forward:
    - 9229:9229
  
  kitchen:
    image: ${OKTETO_BUILD_KITCHEN_DEV_IMAGE}
    command: bash
    sync:
    - kitchen:/usr/src/app
    environment:
     GIN_MODE: debug

